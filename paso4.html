<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<title>Datos de la Operaci贸n</title>
</head>
<body class="bg-light d-flex justify-content-center align-items-center min-vh-100">
	<div class="container">
		<div class="card shadow p-4">
			<h4 class="mb-4 text-center">Datos de la Operacion</h4>
			<form id="form" novalidate>
				<div class=" table-responsive mb-4">
					<!--
						tabla principal de informacion del producto o servicio
					-->
					<table class="table table-bordered"  id="tabla">
						<thead class="table-light">
							<th class="text-center">C贸digo</th>
							<th class="text-center">Producto/Servicio</th>
							<th class="text-center">Cantidad</th>
							<th class="text-center">U. de Medida</th>
							<th class="text-center">Precio Unitario</th>
							<th class="text-center">% Bonificaci贸n</th>
							<th class="text-center">Importe de Bonificacion</th>
							<th class="text-center">Subtotal</th>
							<th class="text-center">Alicuota IVA</th>
							<th class="text-center">Importe</th>
							<th class="text-center">Subtotal con IVA</th>
							<th class="text-danger text-center">Borrar</th>
						</thead>
						<tbody id="section1"></tbody>
						<tbody id="section2"></tbody>
						<tbody id="section3"></tbody>
					</table>
				</div>
				<!--
					Tabla de Impuestos y retenciones 
				-->
				<div class=" table-responsive mb-4">
					<table class="table table-bordered align-middle" style=" border-color: rgba(69, 69, 69, 6.9); max-height: 600px;">
						<thead class="table-light">
							<tr>
								<th></th>
								<th class="text-center">Detalle</th>
								<th class="text-center">Base Imponible</th>
								<th class="text-center">Alicuota %</th>
								<th class="text-center">Importe</th>
							</tr>
						</thead>
						<tbody class="table-light">
							<tr>
								<td>Per./Ret. de Imp. a las Ganancias</td>
								<td><input class="form-control" id="detalleImpGanancias" type="text"><div class="invalid-feedback">ingrese los detalles</div></td>
								<td><input class="form-control" id="baseImponibleImpGanancias" type="number" oninput="actualizarImportes('ImpGanancias')" required><div class="invalid-feedback">ingrese la base imponible</div></td>
								<td><input class="form-control" id="alicuotaImpGanancias" type="number" oninput="actualizarImportes('ImpGanancias')" required><div class="invalid-feedback">ingrese la alicuota</div></td>
								<td><input class="form-control" id="importeImpGanancias" type="number" readonly></td>
							</tr>
							<tr>
								<td>Per./Ret. de IVA</td>
								<td><input class="form-control" id="detalleIVA" type="text" ><div class="invalid-feedback">ingrese los detalles</div></td>
								<td><input class="form-control" id="baseImponibleIVA" type="number" oninput="actualizarImportes('IVA')" required><div class="invalid-feedback">ingrese la base imponible</div></td>
								<td><input class="form-control" id="alicuotaIVA" type="number" oninput="actualizarImportes('IVA')" required><div class="invalid-feedback">ingrese la alicuota</div></td>
								<td><input class="form-control" id="importeIVA" type="number" readonly></td>
							</tr>
							<tr>
								<td>Per./Ret. Ingresos Brutos</td>
								<td><input class="form-control" id="detalleIngresosBrutos" type="text"><div class="invalid-feedback">ingrese los detalles</div></td>
								<td><input class="form-control" id="baseImponibleIngresosBrutos" type="number" oninput="actualizarImportes('IngresosBrutos')" required><div class="invalid-feedback">ingrese la base imponible</div></td>
								<td><input class="form-control" id="alicuotaIngresosBrutos" type="number" oninput="actualizarImportes('IngresosBrutos')" required><div class="invalid-feedback">ingrese la alicuota</div></td>
								<td><input class="form-control" id="importeIngresosBrutos" type="number" readonly></td>
							</tr>
							<tr>
								<td>Impuestos Internos</td>
								<td><input class="form-control" id="detalleImpInternos" type="text"><div class="invalid-feedback">ingrese los detalles</div></td>
								<td><input class="form-control" id="baseImponibleImpInternos" type="number" oninput="actualizarImportes('ImpInternos')" required><div class="invalid-feedback">ingrese la base imponible</div></td>
								<td><input class="form-control" id="alicuotaImpInternos" type="number" oninput="actualizarImportes('ImpInternos')" required><div class="invalid-feedback">ingrese la alicuota</div></td>
								<td><input class="form-control" id="importeImpInternos" type="number" readonly></td>
							</tr>
							<tr>
								<td>Impuesos Municipales</td>
								<td><input class="form-control" id="detalleImpMunicipales" type="text"><div class="invalid-feedback">ingrese los detalles</div></td>
								<td><input class="form-control" id="baseImponibleImpMunicipales" type="number" oninput="actualizarImportes('ImpMunicipales')" required><div class="invalid-feedback">ingrese la base imponible</div></td>
								<td><input class="form-control" id="alicuotaImpMunicipales" type="number" oninput="actualizarImportes('ImpMunicipales')" required><div class="invalid-feedback">ingrese la alicuota</div></td>
								<td><input class="form-control" id="importeImpMunicipales" type="number" readonly></td>
							</tr>
						</tbody>
					</table>
				</div>
				<!-- tabla de importes e IVA-->
				<div class="row">
					<div class="col-md-4">
						<label>Importe Otros Tributos</label>
						<input type="number" id="importeOtrosTributos" class="form-control" readonly>
						</div>
					<div class="col-md-4">
						<label>Importe Neto No Gravado</label>
						<input class="form-control" id="importeNetoNoGravado" type="number" readonly>
					</div>
					<div class="col-md-4"> 
						<label>Importe Exento</label>
						<input class="form-control" id="importeExcento" type="number" readonly>
					</div>
					<div class="col-md-4">	
						<label>Importe Neto Gravado</label>
						<input class="form-control" id="importeNetoGravado" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 27%</label>
						<input class="form-control" id="IVA27" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 21%</label>
						<input class="form-control" id="IVA21" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 10.5%</label>
						<input class="form-control" id="IVA10_5" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 5%</label>
						<input class="form-control" id="IVA5" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 2.5%</label>
						<input class="form-control" id="IVA2_5" type="number" readonly>
					</div>
					<div class="col-md-4">
						<label>IVA 0%</label>
						<input class="form-control" id="IVA0" type="number" readonly>
					</div>
				</div>

				<div class="d-flex justify-content-between mt-4">
					<button class="btn btn-secondary" onclick="window.location.href='paso3.html'">Anterior</a>
					<button class="btn btn-primary" type="submit">Finalizar</button>
				</div>
			</form>
		</div>
	</div>
	<script type="text/javascript">
		const form = document.getElementById('form');
		const datosGuardados=JSON.parse(localStorage.getItem('DataPaso4'));
		const camposTabla = ['codigo', 'ProductoServicio', 'cantidad', 'uDeMedida', 'precioUnitario', 'bonificacion', 'importeBonificacion', 'subtotal', 'alicuotaIVA', 'importe', 'subtotalConIVA'];
		const  otrosCampos = ['detalleImpGanancias', 'baseImponibleImpGanancias', 'alicuotaImpGanancias', 'importeImpGanancias', 'detalleIVA', 'baseImponibleIVA', 'alicuotaIVA', 'importeIVA', 'detalleIngresosBrutos', 'baseImponibleIngresosBrutos', 'alicuotaIngresosBrutos', 'importeIngresosBrutos', 'detalleImpInternos', 'baseImponibleImpInternos', 'alicuotaImpInternos', 'importeImpInternos', 'detalleImpMunicipales', 'baseImponibleImpMunicipales', 'alicuotaImpMunicipales', 'importeImpMunicipales', 'importeOtrosTributos'];
		
		function eliminarSeccion(numSeccion){	//funcion para deshanilitar una fila de inputs
			//pregunta si ya hay un campo inhabilitado para confirmar su estado
			const boton = document.getElementById('button'+numSeccion.toString());
			if(!document.getElementById('codigo'+numSeccion.toString()).disabled){
				//inhabilita campo por campo la fila completa
				camposTabla.forEach(campo => {
					const input = document.getElementById(campo+numSeccion.toString());
					input.value = "";
					input.disabled = true;
					input.classList.remove('is-invalid');	//si inhabilita el campo elimina el mensaje de error al estar este vacio;
					boton.classList.remove('btn-danger');	//cambia la forma del boton dependiendo de si esta desactivado o no
					boton.innerHTML= 'O';
					boton.classList.add('btn-light');
				});
			} else camposTabla.forEach(campo => {	//activa los campos
				document.getElementById(campo+numSeccion.toString()).disabled = false;
				boton.classList.remove('btn-light');
				boton.innerHTML = 'X';
				boton.classList.add('btn-danger');
			});
		}

		function actualizarImportes(tipoImporte){
			const baseImponible=Number(document.getElementById('baseImponible' + tipoImporte).value), alicuota = Number(document.getElementById('alicuota' + tipoImporte).value), importe = document.getElementById('importe' + tipoImporte);
			importe.value = baseImponible + (baseImponible*alicuota)/100;
			importe.dispatchEvent(new Event("change"));
		}
		['importeImpGanancias', 'importeIVA', 'importeIngresosBrutos', 'importeImpInternos', 'importeImpMunicipales'].forEach(id=>{
			document.getElementById(id).addEventListener("change", () =>{
				document.getElementById('importeOtrosTributos').value = Number(document.getElementById('importeImpGanancias').value) + Number(document.getElementById('importeIVA').value) + Number(document.getElementById('importeIngresosBrutos').value) + Number(document.getElementById('importeImpInternos').value) + Number(document.getElementById('importeImpMunicipales').value);
			});
		})
		window.addEventListener('DOMContentLoaded', () =>{
			//genera las tres filas de inputs de la primera tabla
			for(let i=1; i<=3; i++){
				const seccionTabla=document.getElementById(`section${i}`);
				const filaInputs= document.createElement("tr");
				let stringFilaInputs = `
					<td><input type="number" id="codigo${i}" class="form-control" required><div class="invalid-feedback">Ingrese el c贸digo</div></td>
					<td><select id="ProductoServicio${i}" class="form-select" required>
						<option value="">...</option>
						<option value="Producto">Producto</option>
						<option value="Servicio">Servicio</option>
					</select>
					<div class="invalid-feedback">Seleccione una opcion</div></td>
					<td><input type="number" id="cantidad${i}" class="form-control" required><div class="invalid-feedback">ingrese la cantidad</div></td>
					<td>
						<select id="uDeMedida${i}" class="form-select" required>
							<option value="">...</option>
							<option value="kg">Kilogramo</option>
							<option value="g">gramo</option>
							<option value="m">Metros</option>
							<option value="cm">Centimetros</option>
							<option value="li">Litros</option>
							<option value="ml">Mililitros</option>
							<option value="oz">Onzas</option>
						</select>
						<div class="invalid-feedback">Seleccione una unidad de medida</div>
					</td>
					<td><input type="number" id="precioUnitario${i}" class="form-control" required><div class="invalid-feedback">ingrese el precio por unidad</div></td>
					<td><input type="number" id="bonificacion${i}" class="form-control" required><div class="invalid-feedback">ingrese el porcentaje de bonificacion</div></td>
					<td><input type="number" id="importeBonificacion${i}" readonly class="form-control"></td>
					<td><input type="number" id="subtotal${i}" readonly class="form-control"></td>
					<td><input type="number" id="alicuotaIVA${i}" readonly class="form-control"></td>
					<td><input type="number" id="importe${i}" readonly class="form-control"></td>
					<td><input type="number" id="subtotalConIVA${i}" readonly class="form-control"></td>
			`;
				if(i>1){
					stringFilaInputs+=`<td><button class="btn btn-danger" type="button" id="button${i}" onclick="eliminarSeccion(${i})"> X </button></td>`;
				} else{
					stringFilaInputs+=`<td></td>`;
				}
				stringFilaInputs+=`</tr>`;
				filaInputs.innerHTML = stringFilaInputs;
				seccionTabla.appendChild(filaInputs);

				// cargar los datos guardados

				/*const codigo = document.getElementById(`codigo${i}`);
				const ProductoServicio = document.getElementById(`ProductoServicio${i}`);
				const cantidad = document.getElementById(`cantidad${i}`);
				const uDeMedida = document.getElementById(`uDeMedida${i}`);
				const precioUnitario = document.getElementById(`precioUnitario${i}`);
				const bonificacion = document.getElementById(`bonificacion${i}`);
				const importeBonificacion = document.getElementById(`importeBonificacion${i}`);
				const subtotal = document.getElementById(`subtotal${i}`);
				const alicuotaIVA = document.getElementById(`alicuotaIVA${i}`);
				const importe = document.getElementById(`importe${i}`);
				const subtotalConIVA = document.getElementById(`subtotalConIVA${i}`);*/
			}
			for(let i=1; i<=3; i++)camposTabla.forEach(valor=>{document.getElementById(valor+ i.toString()).value = datosGuardados.table[i-1][valor] || '';});
			otrosCampos.forEach(valor=>{document.getElementById(valor).value = datosGuardados[valor] || '';});
		});

		//actualizar los inputs de solo lectura a medida que el usuario ingresa datos


		form.addEventListener("submit",(e)=>{
			e.preventDefault();
			let validar=true;
			for(let i =1; i<=3;i++){	//validar los campos de la tabla principal
				camposTabla.forEach((valor, indice) =>{
					if(indice>5) return;
					const input=document.getElementById(valor+i.toString());
					if(input.value === '' && (!input.disabled&&input.required)) {
						input.classList.add('is-invalid');
						validar=false;
					} else input.classList.remove('is-invalid');
				});
			}
			otrosCampos.forEach(campo =>{
				const input=document.getElementById(campo);
				if(input.value === '' && input.required) {
					input.classList.add('is-invalid');
					validar=false;
				} else input.classList.remove('is-invalid');
			});
			if(!validar) return;

			const table = [];
			for(let i=1;i<=3;i++){	//el array guarda los datos de 3 objetos
				table.push({
					codigo: document.getElementById(`codigo${i}`).value||'',
					ProductoServicio: document.getElementById(`ProductoServicio${i}`).value||'',
					cantidad: document.getElementById(`cantidad${i}`).value||'',
					uDeMedida: document.getElementById(`uDeMedida${i}`).value||'',
					precioUnitario: document.getElementById(`precioUnitario${i}`).value||'',
					bonificacion: document.getElementById(`bonificacion${i}`).value||'',
					importeBonificacion: document.getElementById(`importeBonificacion${i}`).value||'',
					subtotal: document.getElementById(`subtotal${i}`).value||'',
					alicuotaIVA: document.getElementById(`alicuotaIVA${i}`).value||'',
					importe: document.getElementById(`importe${i}`).value||'',
					subtotalConIVA: document.getElementById(`subtotalConIVA${i}`).value||''
				});
			}
			const data = {table: table};
			for(let i=0;i<otrosCampos.length;i++) data[otrosCampos[i]] = document.getElementById(otrosCampos[i]).value||'';

			localStorage.setItem('DataPaso4', JSON.stringify(data));
			window.location.href="final.html";
		});
	</script>
</body>
</html>	
